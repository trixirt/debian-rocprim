#!/usr/bin/make -f
export CXX=hipcc
export DEB_BUILD_MAINT_OPTIONS = hardening=-all
export VERBOSE=1
#export AMD_LOG_LEVEL=4

%:
	dh $@ -Scmake

CMAKE_FLAGS = \
	-DCMAKE_BUILD_TYPE=Release \
	-DBUILD_FILE_REORG_BACKWARD_COMPATIBILITY=OFF

ifeq (,$(filter nocheck,$(DEB_BUILD_OPTIONS)))
CMAKE_FLAGS += -DBUILD_TEST=ON
endif

%:
	dh $@ -Scmake

override_dh_auto_configure:
	dh_auto_configure -- $(CMAKE_FLAGS)

override_dh_auto_test:
ifeq (,$(filter nocheck,$(DEB_BUILD_OPTIONS)))
	set -e \
	; if [ -r /dev/kfd ] \
	; then dh_auto_test --no-parallel -- \
	; else echo "W: /dev/kfd unreadable: no available AMD GPU." \
	;      echo "W: tests skipped." \
	; fi
endif

override_dh_auto_install:
	dh_auto_install --destdir=debian/tmp

override_dh_dwz:
	@echo "W: debug symbols unavailable for the moment[1]."
	@echo "W: [1]: https://github.com/ROCm-Developer-Tools/hipamd/issues/17"
